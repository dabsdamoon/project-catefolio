<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catefolio - Transaction Workspace</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Work+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-ink: #101828;
        --color-ink-soft: #475467;
        --color-ink-subtle: #667085;
        --color-canvas: #f6f4f1;
        --color-surface: #ffffff;
        --color-brand: #f97316;
        --color-brand-dark: #ea580c;
        --color-emerald: #0ea5a4;
        --color-amber: #f59e0b;
        --color-rose: #f43f5e;
        --color-slate: #1f2937;
        --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
        --shadow-hard: 0 24px 60px rgba(15, 23, 42, 0.16);
        --radius-xl: 32px;
        --radius-lg: 22px;
        --radius-md: 14px;
        --radius-sm: 10px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Work Sans", "Helvetica Neue", sans-serif;
        color: var(--color-ink);
        background: radial-gradient(circle at top left, #fff1e6 0%, transparent 55%),
          radial-gradient(circle at 85% 10%, #e7f9f7 0%, transparent 45%),
          var(--color-canvas);
        min-height: 100vh;
        line-height: 1.5;
      }

      .page {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 32px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 24px 64px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 24px;
        margin-bottom: 24px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 16px;
        font-family: "Space Grotesk", sans-serif;
      }

      .logo-badge {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: conic-gradient(from 130deg, #f97316, #fb7185, #0ea5a4, #f97316);
        box-shadow: var(--shadow-soft);
        display: grid;
        place-items: center;
        color: white;
        font-weight: 700;
      }

      .logo h1 {
        font-size: 26px;
        margin: 0;
      }

      .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 12px 22px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--color-brand), var(--color-brand-dark));
        color: white;
        box-shadow: 0 12px 24px rgba(249, 115, 22, 0.28);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 32px rgba(249, 115, 22, 0.32);
      }

      .btn-ghost {
        background: white;
        border: 1px solid #e4e7ec;
        color: var(--color-ink);
      }

      .sidebar {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-soft);
        height: fit-content;
      }

      .nav-group {
        margin-top: 24px;
      }

      .nav-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 14px;
        color: var(--color-ink-soft);
        cursor: pointer;
      }

      .nav-item.active {
        background: #fff7ed;
        color: #9a3412;
        font-weight: 600;
      }

      .main {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .hero-card {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        padding: 24px 28px;
        box-shadow: var(--shadow-soft);
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .stat {
        background: #f8fafc;
        border-radius: 16px;
        padding: 18px;
      }

      .stat p {
        font-size: 12px;
        color: var(--color-ink-subtle);
        margin: 0 0 8px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .stat h3 {
        font-family: "Space Grotesk", sans-serif;
        margin: 0;
        font-size: 26px;
      }

      .section {
        margin-bottom: 24px;
      }

      .section-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .section-title h3 {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        font-size: 24px;
      }

      .section-title span {
        color: var(--color-ink-subtle);
        font-size: 14px;
      }

      .upload-panel {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        border: 2px dashed #f3d6be;
        padding: 40px;
        text-align: center;
        box-shadow: var(--shadow-soft);
        position: relative;
      }

      .upload-panel h4 {
        margin: 16px 0 8px;
        font-size: 20px;
      }

      .upload-panel p {
        margin: 0 0 24px;
        color: var(--color-ink-subtle);
      }

      .steps {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-top: 32px;
      }

      .step {
        border-radius: var(--radius-md);
        background: #ffffff;
        padding: 20px;
        border: 1px solid #f1f1f1;
      }

      .step h5 {
        margin: 0 0 8px;
        font-size: 16px;
        font-weight: 600;
      }

      .step p {
        margin: 0;
        font-size: 13px;
        color: var(--color-ink-subtle);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 24px;
      }

      .card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-soft);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: #fff7ed;
        color: #9a3412;
        font-size: 12px;
        font-weight: 600;
      }

      .category-list {
        display: grid;
        gap: 12px;
      }

      .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        border-radius: var(--radius-md);
        background: #f8fafc;
      }

      .category-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .category-meta span {
        font-size: 12px;
        color: var(--color-ink-subtle);
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 12px;
      }

      .table th,
      .table td {
        text-align: left;
        padding: 12px 10px;
        border-bottom: 1px solid #eef2f6;
      }

      .table th {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--color-ink-subtle);
      }

      .pill-toggle {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        background: #ffffff;
        border-radius: 999px;
        padding: 6px;
        border: 1px solid #e4e7ec;
      }

      .pill-toggle button {
        border: none;
        background: transparent;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: var(--color-ink-subtle);
        cursor: pointer;
      }

      .pill-toggle button.active {
        background: var(--color-slate);
        color: white;
      }

      .charts {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .chart-card {
        padding: 20px;
        border-radius: var(--radius-lg);
        background: white;
        box-shadow: var(--shadow-soft);
      }

      .chart-card h4 {
        margin: 0 0 12px;
        font-size: 16px;
      }

      .chart-canvas {
        width: 100%;
        height: 180px;
        background: linear-gradient(180deg, #fff 0%, #f8fafc 100%);
        border-radius: 14px;
        border: 1px solid #f1f1f1;
      }

      .report {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 24px;
      }

      .report-card h4 {
        margin: 0 0 16px;
        font-size: 18px;
      }

      .callout {
        background: #fff7ed;
        border-left: 4px solid var(--color-brand);
        padding: 16px;
        border-radius: 12px;
        font-size: 14px;
        color: #7c2d12;
      }

      .api-panel {
        display: grid;
        gap: 12px;
        font-family: "Space Grotesk", sans-serif;
      }

      .api-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        background: #0f172a;
        color: white;
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 13px;
      }

      .api-row span {
        color: #93c5fd;
      }

      .footer {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
        margin-top: 40px;
      }

      .workspace-title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .workspace-title h2 {
        font-family: "Space Grotesk", sans-serif;
        font-size: 28px;
        margin: 0;
      }

      .workspace-title p {
        margin: 0;
        color: var(--color-ink-subtle);
      }

      .template-preview {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-soft);
      }

      .template-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      .template-scroll {
        overflow-x: auto;
        border: 1px solid #e4e7ec;
        border-radius: 16px;
      }

      .template-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 16px;
      }

      .template-table th,
      .template-table td {
        border: 1px solid #e4e7ec;
        padding: 6px 8px;
        text-align: left;
      }

      .template-table th {
        background: #fef3c7;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .template-table td.amount {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .template-section {
        margin-top: 24px;
      }

      .template-label {
        font-weight: 600;
        color: var(--color-ink-soft);
        margin-bottom: 8px;
      }

      .footer .card {
        padding: 18px;
      }

      @media (max-width: 980px) {
        .page {
          grid-template-columns: 1fr;
        }

        .grid-2 {
          grid-template-columns: 1fr;
        }

        .charts {
          grid-template-columns: 1fr;
        }

        .report {
          grid-template-columns: 1fr;
        }

        .footer {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 720px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .steps {
          grid-template-columns: 1fr;
        }

        .stat-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <aside class="sidebar">
        <div class="logo">
          <div class="logo-badge">CF</div>
          <div>
            <h1>Catefolio</h1>
            <div style="font-size: 12px; color: var(--color-ink-subtle); font-weight: 600">
              Transaction Workspace
            </div>
          </div>
        </div>
        <div class="nav-group">
          <div class="nav-item active">Workspace</div>
          <div class="nav-item">Entities</div>
          <div class="nav-item">Categories</div>
          <div class="nav-item">Insights</div>
          <div class="nav-item">Exports</div>
        </div>
      </aside>

      <main class="main">
        <header>
          <div class="workspace-title">
            <h2>Template Conversion</h2>
            <p>Upload statements, then preview credit/debit tables in template format.</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-ghost" id="template-download" disabled>
              Download Excel
            </button>
            <button class="btn btn-primary" id="template-trigger">Upload Files</button>
            <input id="template-input" type="file" multiple accept=".csv,.xls,.xlsx" hidden />
          </div>
        </header>

        <section class="hero-card">
          <div class="section-title">
            <h3>Batch Summary</h3>
            <span id="summary-date-range">Awaiting upload</span>
          </div>
          <div class="stat-grid">
            <div class="stat">
              <p>Total Income</p>
              <h3 id="summary-income">$0</h3>
            </div>
            <div class="stat">
              <p>Total Expenses</p>
              <h3 id="summary-expenses">$0</h3>
            </div>
            <div class="stat">
              <p>Net Savings</p>
              <h3 id="summary-net">$0</h3>
            </div>
          </div>
          <p id="template-status" style="margin-top: 16px; color: var(--color-ink-subtle);">
            Upload files to generate the template-formatted report.
          </p>
        </section>

        <section class="template-preview">
          <div class="section-title">
            <h3>Template Preview</h3>
            <span>Credit and debit tables grouped by date</span>
          </div>
          <div class="template-controls">
            <div class="pill-toggle">
              <button class="active" id="template-page-prev">Prev</button>
              <button class="active" id="template-page-next">Next</button>
            </div>
            <span id="template-page-status" style="color: var(--color-ink-subtle); font-size: 13px;">
              No dates loaded
            </span>
          </div>
          <div class="template-section">
            <div class="template-label">Credit (입금)</div>
            <div class="template-scroll" id="credit-table"></div>
          </div>
          <div class="template-section">
            <div class="template-label">Debit (지출)</div>
            <div class="template-scroll" id="debit-table"></div>
          </div>
        </section>

      <section class="section grid-2">
        <div class="card">
          <div class="section-title">
            <h3>2. Category builder</h3>
            <span>Custom categories + keywords</span>
          </div>
          <div class="category-list">
            <div class="category-item">
              <div class="category-meta">
                <strong>Travel - Business</strong>
                <span>Keywords: flight, hotel, conference, uber</span>
              </div>
              <span class="tag">Business</span>
            </div>
            <div class="category-item">
              <div class="category-meta">
                <strong>Dining Out</strong>
                <span>Keywords: doordash, starbucks, sweetgreen</span>
              </div>
              <span class="tag">Personal</span>
            </div>
            <div class="category-item">
              <div class="category-meta">
                <strong>Office Supplies</strong>
                <span>Keywords: staples, amazon business, printer ink</span>
              </div>
              <span class="tag">Business</span>
            </div>
          </div>
          <div style="margin-top: 16px">
            <button class="btn btn-ghost">Add Category</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">
            <h3>Business vs Personal</h3>
            <span>Tag every transaction</span>
          </div>
          <p style="color: var(--color-ink-subtle); margin-bottom: 18px">
            Default to Personal, or override by category or transaction. Combine tags for mixed purchases.
          </p>
          <div class="pill-toggle">
            <button class="active">Combined</button>
            <button>Business</button>
            <button>Personal</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Category</th>
                <th>Tag</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>07/08</td>
                <td>Northwest Flight 482</td>
                <td>Travel - Business</td>
                <td>Business</td>
                <td>-$640</td>
              </tr>
              <tr>
                <td>07/10</td>
                <td>Sweetgreen Downtown</td>
                <td>Dining Out</td>
                <td>Personal</td>
                <td>-$32</td>
              </tr>
              <tr>
                <td>07/11</td>
                <td>Client Retainer</td>
                <td>Income - Consulting</td>
                <td>Business</td>
                <td>$3,200</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section">
        <div class="section-title">
          <h3>3. Insights dashboard</h3>
          <span>Visual summaries + narrative report</span>
        </div>
        <div class="charts">
          <div class="chart-card">
            <h4>Daily income vs expenses</h4>
            <canvas class="chart-canvas" id="trendChart"></canvas>
          </div>
          <div class="chart-card">
            <h4>Expense breakdown</h4>
            <canvas class="chart-canvas" id="expenseChart"></canvas>
          </div>
          <div class="chart-card">
            <h4>Personal vs Business</h4>
            <canvas class="chart-canvas" id="splitChart"></canvas>
          </div>
        </div>
      </section>

      <section class="section report">
        <div class="card report-card">
          <div class="section-title">
            <h3>Automated narrative</h3>
            <span>GraphRAG-ready insights</span>
          </div>
          <h4>Highlights</h4>
          <p>
            In July you earned $12,480 and spent $8,210, leaving a net savings of $4,270. Your largest
            expense category was Travel (22% of total), driven by a conference trip that also boosted
            consulting income by $2,100.
          </p>
          <div class="callout">
            Unusual activity: Travel spending spiked by 18% over your average. 4 transactions are tagged
            as Business but still categorized under Personal. Review for tax deductions.
          </div>
          <p style="margin-top: 16px">
            Recommendation: Set a monthly cap for Dining Out at $350 to keep discretionary spend below
            10% of expenses.
          </p>
        </div>
        <div class="card report-card">
          <div class="section-title">
            <h3>Exports and templates</h3>
            <span>Excel or PDF output</span>
          </div>
          <ul style="margin: 0; padding-left: 18px; color: var(--color-ink-subtle)">
            <li>Default workbook includes raw transactions, summary tables, and chart data.</li>
            <li>Upload a custom Excel template to fill pre-labeled sheets.</li>
            <li>Generate PDF summary for client-ready reporting.</li>
          </ul>
          <div style="margin-top: 18px">
            <button class="btn btn-ghost">Upload Template</button>
            <button class="btn btn-primary">Download Report</button>
          </div>
        </div>
      </section>

      <section class="section grid-2">
        <div class="card">
          <div class="section-title">
            <h3>API endpoints</h3>
            <span>Cloud Run powered</span>
          </div>
          <div class="api-panel">
            <div class="api-row">
              <div>POST /upload</div>
              <span>file batch ingestion</span>
            </div>
            <div class="api-row">
              <div>GET /result/{jobId}</div>
              <span>categorization output</span>
            </div>
            <div class="api-row">
              <div>GET /report/{jobId}</div>
              <span>narrative + export links</span>
            </div>
            <div class="api-row">
              <div>GET /visualize/{jobId}</div>
              <span>chart-ready data</span>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="section-title">
            <h3>Security and privacy</h3>
            <span>Firebase-backed</span>
          </div>
          <p style="color: var(--color-ink-subtle)">
            Encrypted transfers, scoped access tokens, and optional data deletion after report generation.
            Firebase stores category rules and transaction summaries for quick recall and faster learning.
          </p>
          <div class="footer">
            <div class="card">
              <strong>Storage</strong>
              <p style="margin: 8px 0 0; color: var(--color-ink-subtle)">Firestore + secure storage</p>
            </div>
            <div class="card">
              <strong>Processing</strong>
              <p style="margin: 8px 0 0; color: var(--color-ink-subtle)">Cloud Run containers</p>
            </div>
            <div class="card">
              <strong>Access</strong>
              <p style="margin: 8px 0 0; color: var(--color-ink-subtle)">User-scoped API keys</p>
            </div>
          </div>
        </div>
      </section>
      </main>
    </div>

    <script>
      const API_BASE = "http://localhost:8000";

      const templateTrigger = document.getElementById("template-trigger");
      const templateInput = document.getElementById("template-input");
      const templateDownload = document.getElementById("template-download");
      const templateStatus = document.getElementById("template-status");
      let latestTemplateBlob = null;

      templateTrigger.addEventListener("click", () => templateInput.click());

      const formatCurrency = (value) =>
        new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(value || 0);

      let templateDates = [];
      let templateGrouped = {};
      let templatePage = 0;
      const datesPerPage = 6;

      const updateTemplatePagination = () => {
        const total = templateDates.length;
        if (!total) {
          document.getElementById("template-page-status").textContent = "No dates loaded";
          return;
        }
        const start = templatePage * datesPerPage + 1;
        const end = Math.min(total, (templatePage + 1) * datesPerPage);
        document.getElementById(
          "template-page-status"
        ).textContent = `Showing ${start}-${end} of ${total} dates`;
      };

      const buildTemplateTable = (entriesByDate, label, dates) => {
        if (!dates.length) {
          return `<div style="color: var(--color-ink-subtle); font-size: 14px;">No ${label} entries yet.</div>`;
        }

        let header = `<tr><th>날짜</th>`;
        dates.forEach((date) => {
          header += `<th colspan="2">${date}</th>`;
        });
        header += `</tr>`;

        let subHeader = `<tr><th>항목</th>`;
        dates.forEach(() => {
          subHeader += `<th>내용</th><th>금액</th>`;
        });
        subHeader += `</tr>`;

        const maxRows = Math.max(...dates.map((date) => entriesByDate[date].length));
        let body = "";
        for (let i = 0; i < maxRows; i += 1) {
          let row = `<tr><td>${i + 1}</td>`;
          dates.forEach((date) => {
            const entry = entriesByDate[date][i];
            if (entry) {
              row += `<td>${entry.description}</td><td class="amount">${Math.abs(
                entry.amount
              ).toLocaleString()}</td>`;
            } else {
              row += "<td></td><td></td>";
            }
          });
          row += "</tr>";
          body += row;
        }

        return `<table class="template-table">${header}${subHeader}${body}</table>`;
      };

      const renderTemplatePreview = (transactions) => {
        const grouped = {};
        transactions.forEach((tx) => {
          const date = tx.date || "Unknown";
          grouped[date] ||= { credit: [], debit: [] };
          if (tx.amount >= 0) {
            grouped[date].credit.push(tx);
          } else {
            grouped[date].debit.push(tx);
          }
        });

        templateGrouped = grouped;
        templateDates = Object.keys(grouped).sort();
        templatePage = 0;
        renderTemplatePage();
      };

      const renderTemplatePage = () => {
        const start = templatePage * datesPerPage;
        const end = start + datesPerPage;
        const slice = templateDates.slice(start, end);
        const creditEntries = {};
        const debitEntries = {};
        slice.forEach((date) => {
          creditEntries[date] = templateGrouped[date].credit;
          debitEntries[date] = templateGrouped[date].debit;
        });
        document.getElementById("credit-table").innerHTML = buildTemplateTable(
          creditEntries,
          "credit",
          slice
        );
        document.getElementById("debit-table").innerHTML = buildTemplateTable(
          debitEntries,
          "debit",
          slice
        );
        updateTemplatePagination();
      };

      document.getElementById("template-page-prev").addEventListener("click", () => {
        if (templatePage > 0) {
          templatePage -= 1;
          renderTemplatePage();
        }
      });

      document.getElementById("template-page-next").addEventListener("click", () => {
        const maxPage = Math.max(0, Math.ceil(templateDates.length / datesPerPage) - 1);
        if (templatePage < maxPage) {
          templatePage += 1;
          renderTemplatePage();
        }
      });

      templateInput.addEventListener("change", async () => {
        if (!templateInput.files.length) {
          return;
        }
        const fileNames = Array.from(templateInput.files).map((file) => file.name).join(", ");
        templateStatus.textContent = `Uploading ${templateInput.files.length} file(s): ${fileNames}`;
        templateDownload.disabled = true;
        latestTemplateBlob = null;

        const formData = new FormData();
        Array.from(templateInput.files).forEach((file) => {
          formData.append("files", file);
        });

        try {
          templateStatus.textContent = "Processing... this can take a few seconds for large files.";
          const uploadResponse = await fetch(`${API_BASE}/upload`, {
            method: "POST",
            body: formData,
          });
          if (!uploadResponse.ok) {
            throw new Error(`Upload failed (${uploadResponse.status})`);
          }
          const uploadData = await uploadResponse.json();
          const jobId = uploadData.job_id;
          const resultResponse = await fetch(`${API_BASE}/result/${jobId}`);
          if (!resultResponse.ok) {
            throw new Error(`Result failed (${resultResponse.status})`);
          }
          const resultData = await resultResponse.json();

          document.getElementById("summary-income").textContent = formatCurrency(resultData.summary.total_income);
          document.getElementById("summary-expenses").textContent = formatCurrency(resultData.summary.total_expenses);
          document.getElementById("summary-net").textContent = formatCurrency(resultData.summary.net_savings);
          renderTemplatePreview(resultData.transactions);

          const templateResponse = await fetch(`${API_BASE}/template/convert`, {
            method: "POST",
            body: formData,
          });
          if (!templateResponse.ok) {
            throw new Error(`Template export failed (${templateResponse.status})`);
          }
          latestTemplateBlob = await templateResponse.blob();
          templateStatus.textContent = "Template output ready. Preview updated below.";
          templateDownload.disabled = false;
        } catch (error) {
          templateStatus.textContent = "Conversion failed. Check the API server logs.";
        }
      });

      templateDownload.addEventListener("click", () => {
        if (!latestTemplateBlob) {
          return;
        }
        const url = URL.createObjectURL(latestTemplateBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "계좌관리_output.xlsx";
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      });

      const drawLine = (canvas, points, stroke, fill) => {
        const ctx = canvas.getContext("2d");
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.beginPath();
        points.forEach((point, index) => {
          const x = (index / (points.length - 1)) * (w - 24) + 12;
          const y = h - point * (h - 24) - 12;
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 3;
        ctx.stroke();
        if (fill) {
          ctx.lineTo(w - 12, h - 12);
          ctx.lineTo(12, h - 12);
          ctx.closePath();
          ctx.fillStyle = fill;
          ctx.fill();
        }
      };

      const drawDonut = (canvas, values, colors) => {
        const ctx = canvas.getContext("2d");
        const total = values.reduce((sum, value) => sum + value, 0);
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        let start = -Math.PI / 2;
        values.forEach((value, index) => {
          const slice = (value / total) * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.arc(cx, cy, 70, start, start + slice);
          ctx.closePath();
          ctx.fillStyle = colors[index];
          ctx.fill();
          start += slice;
        });
        ctx.globalCompositeOperation = "destination-out";
        ctx.beginPath();
        ctx.arc(cx, cy, 40, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalCompositeOperation = "source-over";
      };

      const drawSplit = (canvas, values, colors) => {
        const ctx = canvas.getContext("2d");
        const total = values.reduce((sum, value) => sum + value, 0);
        let x = 16;
        const y = canvas.height / 2 - 18;
        const barWidth = canvas.width - 32;
        values.forEach((value, index) => {
          const width = (value / total) * barWidth;
          ctx.fillStyle = colors[index];
          ctx.fillRect(x, y, width, 36);
          x += width;
        });
      };

      const trend = document.getElementById("trendChart");
      const expense = document.getElementById("expenseChart");
      const split = document.getElementById("splitChart");

      [trend, expense, split].forEach((canvas) => {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
      });

      drawLine(
        trend,
        [0.2, 0.35, 0.18, 0.55, 0.4, 0.68, 0.5, 0.72, 0.6],
        "#f97316",
        "rgba(249, 115, 22, 0.12)"
      );
      drawDonut(expense, [42, 28, 14, 16], ["#0ea5a4", "#f97316", "#f43f5e", "#f59e0b"]);
      drawSplit(split, [62, 38], ["#0f172a", "#f97316"]);
    </script>
  </body>
</html>
